<div class="editor-layout" *ngIf="!isLoading(); else loadingTpl">

  <!-- Header -->
  <header class="editor-header">
    <div class="header-start">
      <button class="btn-back" routerLink="/host/properties">
        <svg viewBox="0 0 32 32" width="16" height="16" stroke="currentColor" stroke-width="2.5" fill="none"><path d="M20 28 8.7 16.7a1 1 0 0 1 0-1.4L20 4" /></svg>
      </button>
      <h1 class="header-title">Listing editor</h1>
    </div>
    <div class="header-center">
       <!-- Toggle Switch -->
       <div class="status-toggle-wrapper" *ngIf="canToggleStatus(); else statusBadge">
         <span class="status-label" [class.active]="property()?.isActive">
            {{ getStatusText() }}
         </span>
         <label class="switch">
           <input type="checkbox" 
                  [checked]="property()?.isActive" 
                  (change)="onStatusToggle($event)">
           <span class="slider round"></span>
         </label>
       </div>

       <!-- Fallback Badge -->
       <ng-template #statusBadge>
         <span class="status-pill" 
               [class.pending]="property()?.status == 1"
               [class.rejected]="property()?.status == 3">
           {{ property()?.status == 1 ? 'Pending Review' : (property()?.status == 3 ? 'Action Required' : 'In Progress') }}
         </span>
       </ng-template>
    </div>
    <div class="header-end">
      <button class="btn-view" (click)="viewListing()" [disabled]="!property()?.id">
        View listing
      </button>
    </div>
  </header>

  <div class="editor-body">
    
    <!-- ================= LEFT SIDEBAR ================= -->
    <aside class="editor-sidebar">
      <!-- Sidebar Items ... (No changes needed here) -->
      <div class="nav-card" [class.active]="activeSection() === 'photos'" (click)="setActiveSection('photos')">
        <div class="nav-header"> <span class="nav-label">Photos</span> </div>
        <div class="nav-content photo-preview">
          <img [src]="getCoverImage()" alt="Cover">
          <span>{{ property()?.images?.length }} photos</span>
        </div>
      </div>

      <div class="nav-card" [class.active]="activeSection() === 'title'" (click)="setActiveSection('title')">
        <div class="nav-header"> <span class="nav-label">Title</span> </div>
        <div class="nav-content text-truncate">{{ property()?.title }}</div>
      </div>

      <div class="nav-card" [class.active]="activeSection() === 'propertyType'" (click)="setActiveSection('propertyType')">
        <div class="nav-header"> <span class="nav-label">Property type</span> </div>
        <div class="nav-content">{{ property()?.propertyType }}</div>
      </div>

      <div class="nav-card" [class.active]="activeSection() === 'pricing'" (click)="setActiveSection('pricing')">
        <div class="nav-header"> <span class="nav-label">Pricing</span> </div>
        <div class="nav-content">EGP {{ property()?.pricing?.basePrice }}</div>
      </div>

      <div class="nav-card" [class.active]="activeSection() === 'capacity'" (click)="setActiveSection('capacity')">
        <div class="nav-header"> <span class="nav-label">Number of guests</span> </div>
        <div class="nav-content">{{ property()?.capacity?.guests }} guests</div>
      </div>

      <div class="nav-card" [class.active]="activeSection() === 'description'" (click)="setActiveSection('description')">
        <div class="nav-header"> <span class="nav-label">Description</span> </div>
        <div class="nav-content text-truncate">{{ property()?.description }}</div>
      </div>

      <div class="nav-card" [class.active]="activeSection() === 'amenities'" (click)="setActiveSection('amenities')">
        <div class="nav-header"> <span class="nav-label">Amenities</span> </div>
        <div class="nav-content">{{ property()?.amenities?.length }} amenities</div>
      </div>

      <div class="nav-card" [class.active]="activeSection() === 'location'" (click)="setActiveSection('location')">
        <div class="nav-header"> <span class="nav-label">Location</span> </div>
        <div class="nav-content text-truncate">{{ property()?.location?.city }}</div>
      </div>

      <div class="nav-card link-card" (click)="setActiveSection('host')">
        <div class="nav-header"> <span class="nav-label">About the host</span> </div>
         <div class="nav-content">
            
            @if (authService.user(); as currentUser) {
              <div class="host-avatar-wrapper">
                
                <div class="avatar-placeholder small">
                  {{ currentUser.firstName?.charAt(0) | uppercase }}
                </div>

                
                <img *ngIf="currentUser.profilePicture" 
                    [src]="currentUser.profilePicture" 
                    class="host-avatar-img" 
                    alt="Host"
                    (error)="handleImageError($event)">
              </div>
                <span class="host-name-text">{{ currentUser.firstName }}</span>
            }
    </div>
      </div>

      <div class="nav-card" [class.active]="activeSection() === 'booking'" (click)="setActiveSection('booking')">
        <div class="nav-header"> <span class="nav-label">Booking settings</span> </div>
        <div class="nav-content">{{ property()?.isInstantBook ? 'Instant Book' : 'Request' }}</div>
      </div>

      <div class="nav-card" [class.active]="activeSection() === 'rules'" (click)="setActiveSection('rules')">
        <div class="nav-header"> <span class="nav-label">House rules</span> </div>
        <div class="nav-content">{{ property()?.houseRules?.checkInTime }} check-in</div>
      </div>

      <div class="nav-card" [class.active]="activeSection() === 'safety'" (click)="setActiveSection('safety')">
        <div class="nav-header"> <span class="nav-label">Guest safety</span> </div>
        <div class="nav-content">Safety details</div>
      </div>

      <!-- Delete Button -->
      <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #EBEBEB;">
        <button class="btn-delete" (click)="deleteProperty()">
          <svg viewBox="0 0 32 32" width="16" height="16" fill="currentColor" style="margin-right:8px">
            <path d="M28 6h-6V2.996c0-.55-.446-1.004-.996-1.004H10.996A.997.997 0 0 0 10 2.996V6H4v2h2v20.996c0 .55.446 1.004.996 1.004h18.008a.997.997 0 0 0 .996-1.004V8h2V6zm-4 22H8V8h16v20zM12 2.996h8V6h-8V2.996z"/>
          </svg>
          Delete listing
        </button>
      </div>
    </aside>

    <!-- ================= RIGHT CONTENT ================= -->
    <main class="editor-main">
      
      <!-- 1. PHOTOS -->
      <section *ngIf="activeSection() === 'photos'" class="editor-section">
        <div class="section-header">
          <h2 class="section-title">Photos</h2>
          <span class="photo-count">{{ property()?.images?.length }} photos</span>
        </div>
        
        <p class="desc">Drag and drop to reorder. The main image will be your cover photo.</p>

        <div class="photos-grid-manager">
          <div class="photo-upload-card" (click)="fileInput.click()">
            <input #fileInput type="file" multiple (change)="handleImageUpload($event)" hidden accept="image/*">
            <div class="upload-icon">
              <svg viewBox="0 0 32 32" width="32" height="32" fill="currentColor"><path d="M28 2h-6v2h6v6h2V4h6V2h-6zm-4 22H8V8h16v2h2V8a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-8h-2v8zM12 4.004h8V6h-8V4.004z"/></svg>
            </div>
            <span>Add photos</span>
          </div>

          <div *ngFor="let img of property()?.images" class="photo-card-manager" [class.is-primary]="img.isPrimary">
            <img [src]="img.url" alt="Property Image">
            <div class="primary-badge" *ngIf="img.isPrimary">Cover Photo</div>
            <div class="photo-actions-overlay">
              <button *ngIf="!img.isPrimary" 
                      class="action-btn set-cover" 
                      (click)="setAsPrimary(img.id)" 
                      title="Set as cover photo">
                Make Cover
              </button>
              <button class="action-btn delete" 
                      (click)="deleteImage(img.id)"
                      title="Delete photo">
                <svg viewBox="0 0 32 32" width="16" height="16" fill="currentColor"><path d="M28 6h-6V2.996c0-.55-.446-1.004-.996-1.004H10.996A.997.997 0 0 0 10 2.996V6H4v2h2v20.996c0 .55.446 1.004.996 1.004h18.008a.997.997 0 0 0 .996-1.004V8h2V6zm-4 22H8V8h16v20zM12 2.996h8V6h-8V2.996z"/></svg>
              </button>
            </div>
            <div class="img-loader" *ngIf="isImageLoading(img.id)"></div>
          </div>
        </div>
      </section>

      <!-- 2. TITLE -->
      <section *ngIf="activeSection() === 'title'" class="editor-section">
        <h2 class="section-title">Title</h2>
        <div class="form-group">
          <textarea class="airbnb-input large" rows="3" maxlength="50" [(ngModel)]="tempTitle"></textarea>
          <div class="char-count">{{ tempTitle().length }}/50</div>
        </div>
      </section>

      <!-- 3. PROPERTY TYPE (✅ تم التصحيح هنا) -->
      <section *ngIf="activeSection() === 'propertyType'" class="editor-section">
        <h2 class="section-title">Property type</h2>
        <div class="form-group">
          <label>Which is most like your place?</label>
          <div class="select-wrapper">
            
            <select [ngModel]="tempPropertyType()" (ngModelChange)="tempPropertyType.set(+$event)">
              <option [ngValue]="null" disabled>Select property type</option>
              <option *ngFor="let type of propertyTypesList" [value]="type.id">
                {{ type.name }}
              </option>
            </select>
            <span class="chevron">▼</span>
          </div>
        </div>
        <div class="form-group">
          <label>Listing type</label>
          <div class="select-wrapper">
            <select [(ngModel)]="tempRoomType" (ngModelChange)="tempRoomType.set($event)">
              <option [ngValue]="null" disabled>Select listing type</option>
              <option *ngFor="let room of roomTypesList" [value]="room.value">{{ room.label }}</option>
            </select>
            <span class="chevron">▼</span>
          </div>
        </div>
      </section>

      <!-- 4. PRICING -->
      <section *ngIf="activeSection() === 'pricing'" class="editor-section">
        <h2 class="section-title">Pricing</h2>
        <div class="form-group">
          <label>Base price</label>
          <div class="price-input-wrapper">
            <span class="currency">EGP</span>
            <input type="number" class="airbnb-input price" [(ngModel)]="tempPrice">
          </div>
        </div>
        <div class="form-group">
          <label>Cleaning fee</label>
          <div class="price-input-wrapper">
            <span class="currency">EGP</span>
            <input type="number" 
                   class="airbnb-input price" 
                   [ngModel]="tempCleaningFee()"
                   (ngModelChange)="tempCleaningFee.set($event)"
                   placeholder="0">
          </div>
          <p class="input-hint">This fee applies to every reservation, regardless of length.</p>
        </div>
      </section>

      <!-- 5. CAPACITY -->
      <section *ngIf="activeSection() === 'capacity'" class="editor-section">
        <h2 class="section-title">Basics</h2>
        <div class="counter-row">
          <span>Guests</span>
          <div class="counter-controls">
            <button class="circle-btn" (click)="updateCapacity('guests', -1)">-</button>
            <span>{{ tempCapacity().guests }}</span>
            <button class="circle-btn" (click)="updateCapacity('guests', 1)">+</button>
          </div>
        </div>
        <div class="counter-row">
          <span>Bedrooms</span>
          <div class="counter-controls">
            <button class="circle-btn" (click)="updateCapacity('bedrooms', -1)">-</button>
            <span>{{ tempCapacity().bedrooms }}</span>
            <button class="circle-btn" (click)="updateCapacity('bedrooms', 1)">+</button>
          </div>
        </div>
        <div class="counter-row">
          <span>Beds</span>
          <div class="counter-controls">
            <button class="circle-btn" (click)="updateCapacity('beds', -1)">-</button>
            <span>{{ tempCapacity().beds }}</span>
            <button class="circle-btn" (click)="updateCapacity('beds', 1)">+</button>
          </div>
        </div>
        <div class="counter-row">
          <span>Bathrooms</span>
          <div class="counter-controls">
            <button class="circle-btn" (click)="updateCapacity('bathrooms', -1)">-</button>
            <span>{{ tempCapacity().bathrooms }}</span>
            <button class="circle-btn" (click)="updateCapacity('bathrooms', 1)">+</button>
          </div>
        </div>
      </section>

      <!-- 6. DESCRIPTION -->
      <section *ngIf="activeSection() === 'description'" class="editor-section">
        <h2 class="section-title">Description</h2>
        <textarea class="airbnb-input" rows="10" maxlength="500" [(ngModel)]="tempDescription"></textarea>
        <div class="char-count">{{ tempDescription().length }}/500</div>
      </section>

      <!-- 7. AMENITIES -->
      <section *ngIf="activeSection() === 'amenities'" class="editor-section">
        <h2 class="section-title">Amenities</h2>
        <div class="amenities-list">
          <div *ngFor="let amenity of availableAmenities" class="amenity-item">
            <label class="checkbox-label">
              <input type="checkbox" 
                     [checked]="tempAmenities().includes(amenity.id)"
                     (change)="toggleAmenity(amenity.id)">
              <span class="check-text">{{ amenity.name }}</span>
            </label>
          </div>
        </div>
      </section>

      <!-- 8. LOCATION (Interactive Map & Full Fields) -->
      <section *ngIf="activeSection() === 'location'" class="editor-section">
        <h2 class="section-title">Location</h2>
        
        <!-- Street Address -->
        <div class="form-group">
          <label>Street Address</label>
          <input type="text" class="airbnb-input" [(ngModel)]="tempLocation().address" placeholder="e.g. 123 Main St">
        </div>

        <!-- City & State -->
        <div class="form-row">
          <div class="form-group">
            <label>City</label>
            <input type="text" class="airbnb-input" [(ngModel)]="tempLocation().city" placeholder="City">
          </div>
          <!-- <div class="form-group">
            <label>State / Province</label> 
           
            <input type="text" class="airbnb-input" [(ngModel)]="tempLocation().state" placeholder="State">
          </div> -->
        </div>

        <!-- Country & Zip Code -->
        <div class="form-row">
          <div class="form-group">
            <label>Country / Region</label>
            <input type="text" class="airbnb-input" [(ngModel)]="tempLocation().country" placeholder="Country">
          </div>
          <div class="form-group">
            <label>Postal / Zip Code</label> <!-- ✅ حقل جديد -->
            <input type="text" class="airbnb-input" [(ngModel)]="tempLocation().zipCode" placeholder="Postal Code">
          </div>
        </div>
        
        <!-- Interactive Map -->
        <div class="form-group">
          <label>Pin your location</label>
          <p class="input-hint">Drag the pin to adjust the precise location.</p>
          <div class="map-container-wrapper">
            <div id="editor-map" class="map-view"></div>
          </div>
          <!-- عرض الإحداثيات للتأكد (اختياري) -->
          <div class="input-hint" style="margin-top: 8px;">
            Lat: {{ tempLocation().lat | number:'1.4-4' }}, Lng: {{ tempLocation().lng | number:'1.4-4' }}
          </div>
        </div>
      </section>

      <!-- 10. BOOKING SETTINGS (Improved UI) -->
      <section *ngIf="activeSection() === 'booking'" class="editor-section">
        <h2 class="section-title">Decide how you’ll confirm bookings</h2>
        
        <div class="booking-options-container">
          
          <!-- Option 1: Instant Book -->
          <div class="booking-card" 
               [class.selected]="tempInstantBook() === true"
               (click)="setBookingType(true)">
            
            <div class="booking-text">
              <h3>Use Instant Book</h3>
              <p>Guests who meet your requirements can book instantly. You don't need to approve them manually.</p>
            </div>
            
            <div class="custom-radio">
              <div class="radio-inner" *ngIf="tempInstantBook() === true"></div>
            </div>
          </div>

          <!-- Option 2: Request to Book -->
          <div class="booking-card" 
               [class.selected]="tempInstantBook() === false"
               (click)="setBookingType(false)">
            
            <div class="booking-text">
              <h3>Approve or decline requests</h3>
              <p>Guests must send a reservation request. You have 24 hours to approve or decline.</p>
            </div>
            
            <div class="custom-radio">
              <div class="radio-inner" *ngIf="tempInstantBook() === false"></div>
            </div>
          </div>

        </div>
        
        
        <div class="info-box" *ngIf="tempInstantBook() === true">
          <span class="lightning-icon">⚡</span>
          <span>Instant Book listings get more bookings on average.</span>
        </div>

      </section>
      <!-- 11. HOUSE RULES -->
      <section *ngIf="activeSection() === 'rules'" class="editor-section">
        <h2 class="section-title">House rules</h2>
        
        <div class="form-row">
          <!-- Check-in -->
          <div class="form-group">
            <label>Check-in time</label>
            <input type="time" 
                   class="airbnb-input" 
                   [ngModel]="tempRules().checkInTime"
                   (ngModelChange)="updateRule('checkInTime', $event)">
          </div>

          <!-- Check-out -->
          <div class="form-group">
            <label>Check-out time</label>
            <input type="time" 
                   class="airbnb-input" 
                   [ngModel]="tempRules().checkOutTime"
                   (ngModelChange)="updateRule('checkOutTime', $event)">
          </div>
        </div>
      </section>

      <!-- 12. GUEST SAFETY -->
      <section *ngIf="activeSection() === 'safety'" class="editor-section">
        <h2 class="section-title">Guest safety</h2>
        <p class="desc">Does your place have any of these?</p>
        
        <div class="amenities-list">
          
          <!-- Exterior Camera -->
          <div class="amenity-item">
            <label class="checkbox-label">
              <input type="checkbox" 
                     [checked]="tempSafety().exteriorCamera"
                     (change)="toggleSafety('exteriorCamera')"> <!-- ✅ استخدام الدالة الجديدة -->
              <span class="check-text">Exterior security camera</span>
            </label>
          </div>

          <!-- Noise Monitor -->
          <div class="amenity-item">
            <label class="checkbox-label">
              <input type="checkbox" 
                     [checked]="tempSafety().noiseMonitor"
                     (change)="toggleSafety('noiseMonitor')"> <!-- ✅ استخدام الدالة الجديدة -->
              <span class="check-text">Noise decibel monitor</span>
            </label>
          </div>

          <!-- Weapons -->
          <div class="amenity-item">
            <label class="checkbox-label">
              <input type="checkbox" 
                     [checked]="tempSafety().weapons"
                     (change)="toggleSafety('weapons')"> <!-- ✅ استخدام الدالة الجديدة -->
              <span class="check-text">Weapons on property</span>
            </label>
          </div>

        </div>
      </section>

      <!-- SAVE BAR -->
      <div class="save-bar">
        <button class="btn-black" (click)="saveChanges()">Save</button>
      </div>

    </main>
  </div>
</div>

<ng-template #loadingTpl>
  <div class="loading-screen"><div class="spinner"></div></div>
</ng-template>