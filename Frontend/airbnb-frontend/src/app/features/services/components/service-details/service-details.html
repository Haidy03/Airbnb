<div *ngIf="isLoading()" class="d-flex justify-content-center align-items-center vh-100">
  <div class="spinner-border text-danger" role="status"></div>
</div>

<div *ngIf="!isLoading() && service() as s" class="pb-5 mb-5 fade-in"> 

  <!-- 1. Hero Images Grid (Airbnb Style) -->
  <div class="container-fluid px-0 px-md-5 mt-4">
    <div class="gallery-grid rounded-4 overflow-hidden position-relative">
      
      <!-- Main Large Image -->
      <div class="main-img position-relative bg-light">
        <img [src]="getImageUrl(s.images[0])" class="w-100 h-100 object-fit-cover" alt="Main Service Image">
      </div>

      <!-- Side Images (Show only if available) -->
      <div class="side-imgs d-none d-md-grid">
        <div *ngFor="let img of s.images.slice(1, 5)" class="side-img-item bg-light">
          <img [src]="getImageUrl(img)" class="w-100 h-100 object-fit-cover">
        </div>
      </div>

      <!-- Show All Button -->
      <button class="btn btn-light btn-sm position-absolute bottom-0 end-0 m-4 shadow-sm border fw-bold">
        <i class="bi bi-grid-3x3-gap me-2"></i> Show all photos
      </button>
    </div>
  </div>

  <div class="container mt-5" style="max-width: 1120px;">
    <div class="row">
      
      <!-- LEFT COLUMN: Content -->
      <div class="col-lg-7 pe-lg-5">
        
        <!-- Header: Title & Host -->
        <div class="d-flex justify-content-between align-items-start border-bottom pb-4 mb-4">
          <div>
            <h1 class="h2 fw-bold mb-2">{{ s.title }}</h1>
            <p class="text-muted mb-0">
              {{ s.categoryName }} service in {{ s.city }} · 
              <span *ngIf="s.locationType === 'Mobile'">Host travels to you</span>
              <span *ngIf="s.locationType === 'OnSite'">Hosted at specific location</span>
            </p>
            <div class="mt-2 d-flex align-items-center gap-1 small fw-bold">
              <i class="bi bi-star-fill text-dark"></i>
              <span>{{ s.rating | number:'1.1-1' }}</span>
              <span class="text-muted mx-1">·</span>
              <span class="text-decoration-underline">Reviews</span>
            </div>
          </div>
          
          <!-- Host Avatar -->
          <div class="text-center">
            <img [src]="getImageUrl(s.hostAvatar)" 
                 class="rounded-circle object-fit-cover shadow-sm border" 
                 width="56" height="56"
                 onerror="this.src='assets/images/placeholder-user.png'">
            <p class="small text-muted mt-1 mb-0">{{ s.hostName }}</p>
          </div>
        </div>

        <!-- Description -->
        <div class="mb-5 border-bottom pb-4">
          <h3 class="h5 fw-bold mb-3">About this service</h3>
          <p class="text-muted lh-base" style="white-space: pre-line;">{{ s.description }}</p>
        </div>

        <!-- Qualifications -->
        <div *ngIf="s.qualifications.length > 0" class="mb-5 border-bottom pb-4">
          <h3 class="h5 fw-bold mb-4">Why {{ s.hostName }}?</h3>
          <div *ngFor="let q of s.qualifications" class="d-flex gap-3 mb-4">
            <i [class]="'bi fs-4 text-dark ' + (q.icon || 'bi-patch-check')"></i>
            <div>
              <h5 class="h6 fw-bold mb-1">{{ q.title }}</h5>
              <p class="text-muted small mb-0">{{ q.description }}</p>
            </div>
          </div>
        </div>

        <!-- Location Info -->
        <div class="mb-5">
          <h3 class="h5 fw-bold mb-3">Where you'll meet</h3>
          <p class="text-muted mb-2">
            <i class="bi bi-geo-alt me-2"></i> {{ s.city }}
            <span *ngIf="s.coveredAreas" class="ms-1">({{ s.coveredAreas }})</span>
          </p>
          <!-- Static Map Image Placeholder -->
          <div class="rounded-4 overflow-hidden bg-light border mt-3" style="height: 240px;">
             <img src="https://i.imgur.com/HILmr6r.png" class="w-100 h-100 object-fit-cover opacity-75">
          </div>
        </div>

        <!-- Things to know -->
        <div class="row g-4 border-top pt-4">
          <div class="col-6">
            <h6 class="fw-bold">Guest Requirements</h6>
            <p class="small text-muted">{{ s.guestRequirements || 'No specific requirements.' }}</p>
          </div>
          <div class="col-6">
            <h6 class="fw-bold">Cancellation Policy</h6>
            <p class="small text-muted">{{ s.cancellationPolicy || 'Flexible cancellation.' }}</p>
          </div>
        </div>

      </div>

      <!-- RIGHT COLUMN: Sticky Booking -->
      <div class="col-lg-5 mt-5 mt-lg-0">
        <div class="sticky-top" style="top: 100px; z-index: 10;">
          <div class="border rounded-4 shadow-lg p-4 bg-white">
            
            <h3 class="h5 fw-bold mb-3">Choose your package</h3>

            <!-- Packages List -->
            <div class="d-flex flex-column gap-3 mb-4" *ngIf="s.packages.length > 0">
              <div *ngFor="let pkg of s.packages" 
                   class="pkg-card p-3 rounded-3 border cursor-pointer transition"
                   [class.active-pkg]="selectedPackage() === pkg"
                   (click)="selectPackage(pkg)">
                
                <div class="d-flex justify-content-between align-items-start mb-1">
                  <h6 class="fw-bold mb-0">{{ pkg.title }}</h6>
                  <span class="fw-bold text-dark">{{ pkg.price | currency:'EGP ' }}</span>
                </div>
                
                <p class="small text-muted mb-2">{{ pkg.description }}</p>
                <div class="d-flex align-items-center gap-2 small text-secondary">
                  <i class="bi bi-clock"></i> {{ pkg.duration }}
                </div>
              </div>
            </div>

            <div *ngIf="s.packages.length === 0" class="alert alert-light border text-center text-muted">
              Base Service Only
            </div>

            <!-- Total Price Display -->
            <div class="d-flex justify-content-between align-items-center mb-3 pt-3 border-top">
              <span class="fw-bold fs-5">Total</span>
              <span class="fw-bold fs-4">
                {{ (selectedPackage() ? selectedPackage()!.price : s.pricePerUnit) | currency:'EGP ' }}
              </span>
            </div>

            <button class="btn btn-danger w-100 py-3 fw-bold rounded-3" 
                    style="background: #E31C5F;">
              Reserve
            </button>
            
            <div class="text-center mt-3 small text-muted">
              You won't be charged yet
            </div>

          </div>
        </div>
      </div>

    </div>
  </div>

</div>