<div class="checkout-page" *ngIf="listing" style="padding-top: 100px;">

  <header class="checkout-header">
    <button class="icon-btn back-btn" (click)="goBack()">
      <i class="fa-solid fa-chevron-left"></i>
    </button>
    <h1>
      {{ bookingType === 'instant' ? 'Confirm and pay' : 'Request to book' }}
    </h1>
  </header>

  <div class="main-grid">

    <!-- LEFT COLUMN -->
    <div class="left-section">

      <!-- تفاصيل الرحلة (Your trip) -->
      <div class="trip-section">
        <div class="section-header">
          <h2>Your trip</h2>
        </div>
        
        <div class="trip-details-list">
          <div class="trip-item">
            <div class="trip-text">
              <h3>Dates</h3>
              <p>{{ checkIn | date:'mediumDate' }} – {{ checkOut | date:'mediumDate' }}</p>
            </div>
            <button class="edit-btn" (click)="openDateModal()">Edit</button>
          </div>
          
          <div class="trip-item">
            <div class="trip-text">
              <h3>Guests</h3>
              <p>{{ guests }} guest{{ guests > 1 ? 's' : '' }}</p>
            </div>
            <button class="edit-btn" (click)="openGuestModal()">Edit</button>
          </div>
        </div>
      </div>

      <hr class="divider">

      <!-- الدفع أو الطلب (Pay with / Request) -->
      <div class="payment-section">
        <div class="section-header">
          <h2>
            {{ bookingType === 'instant' ? 'Pay with' : 'Message the host' }}
          </h2>
        </div>

        <!-- SCENARIO 1: INSTANT BOOK -->
        <div *ngIf="bookingType === 'instant'">
          
          <!-- اختيار طريقة الدفع -->
          <div class="payment-method-selector" style="margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 10px; padding: 15px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; margin-bottom: 10px;">
              <input type="radio" name="paymentMethod" [(ngModel)]="paymentMethod" value="stripe" />
              <i class="fa-brands fa-cc-stripe" style="font-size: 24px; color: #635bff;"></i>
              <span style="font-weight: 600;">Credit/Debit Card (Stripe)</span>
            </label>
            
          </div>

          <!-- Stripe Payment -->
          <div *ngIf="paymentMethod === 'stripe'" class="stripe-section">
            <button 
              (click)="payWithStripe()" 
              [disabled]="isLoading"
              style="width: 100%; padding: 14px; background: #635bff; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
              <i class="fa-solid fa-lock"></i>
              {{ isLoading ? 'Processing...' : 'Pay with Stripe' }}
            </button>
            <p style="text-align: center; color: #6b7280; font-size: 14px; margin-top: 10px;">
              <i class="fa-solid fa-shield-halved"></i> 
              Secure payment powered by Stripe
            </p>
          </div>

          <!-- PayPal Payment -->
          <div *ngIf="paymentMethod === 'paypal'" class="paypal-wrapper">
            <ngx-paypal [config]="payPalConfig"></ngx-paypal>
            <p style="text-align: center; color: #6b7280; font-size: 14px; margin-top: 10px;">
              <i class="fa-solid fa-lock"></i> Payments are secure and encrypted.
            </p>
          </div>

        </div>

        <!-- SCENARIO 2: REQUEST TO BOOK (MESSAGE) -->
        <div *ngIf="bookingType === 'request'" class="request-box">
          <p class="request-desc">
            Your reservation won't be confirmed until the host accepts your request (within 24 hours).
            You won't be charged until then.
          </p>

          <div class="message-input-box">
            <label>Message the host (optional)</label>
            <textarea 
              rows="4" 
              [(ngModel)]="guestMessage" 
              [ngModelOptions]="{standalone: true}"
              placeholder="Hi, I'd love to book your place for my upcoming trip..."
              class="message-textarea">
            </textarea>
          </div>

          <div class="cancellation-policy">
            <p>By selecting the button below, you agree to the Host's House Rules, Ground rules for guests, and that Airbnb can charge your payment method if you're responsible for damage.</p>
          </div>

          <button 
            class="btn-primary-large" 
            (click)="finalizeBooking()" 
            [disabled]="isLoading">
            {{ isLoading ? 'Sending Request...' : 'Request to Book' }}
          </button>
        </div>

      </div>

    </div>

    <!-- RIGHT COLUMN (Summary) -->
    <div class="right-section">
      <div class="sticky-wrapper">

        <div class="summary-card">
          <!-- Listing Header -->
          <div class="card-header-row">
            <img [src]="getPrimaryImage()" alt="Listing" onerror="this.src='assets/images/placeholder.jpg'">
            <div class="text-info">
              <p class="listing-desc">Entire rental unit</p>
              <h4>{{ listing.title }}</h4>
              <div class="rating">
                <i class="fa-solid fa-star"></i> {{ listing.rating }}
                <span class="count">({{ listing.reviewsCount}} reviews)</span>
              </div>
            </div>
          </div>

          <hr class="divider">

          <!-- Price Breakdown -->
          <div class="price-section">
            <h4>Price details</h4>

            <div class="line-item">
              <span>LE.{{ listing.pricePerNight | number }} x {{ nights }} nights</span>
              <span>LE.{{ listing.pricePerNight * nights | number }}</span>
            </div>

            <div class="line-item">
              <span>Cleaning fee</span>
              <span>LE.{{ (listing.cleaningFee || 0) | number }}</span>
            </div>

            <div class="line-item">
              <span>Airbnb service fee</span>
              <span>LE.{{ serviceFee | number }}</span>
            </div>

            <hr class="divider">

            <div class="line-item total">
              <span>Total (EGP)</span>
              <span>LE.{{ (totalPrice || 0)| number }}</span>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>

  <!-- ================= MODALS (Keep as is) ================= -->
  <!-- Edit Dates Modal -->
  <div class="modal-overlay" *ngIf="isEditDateOpen">
    <div class="modal-box">
      <h3>Change Dates</h3>
      <div class="modal-inputs">
        <label>Check-in</label>
        <input type="date" [(ngModel)]="tempCheckIn">
        <label>Check-out</label>
        <input type="date" [(ngModel)]="tempCheckOut">
      </div>
      <div class="modal-actions">
        <button class="cancel-btn" (click)="closeDateModal()">Cancel</button>
        <button class="save-btn" (click)="saveDates()">Save</button>
      </div>
    </div>
  </div>

  <!-- Edit Guests Modal -->
  <div class="modal-overlay" *ngIf="isEditGuestOpen">
    <div class="modal-box">
      <h3>Change Guests</h3>
      <div class="modal-inputs">
        <label>Adults</label>
        <input type="number" min="1" max="10" [(ngModel)]="tempGuests">
      </div>
      <div class="modal-actions">
        <button class="cancel-btn" (click)="closeGuestModal()">Cancel</button>
        <button class="save-btn" (click)="saveGuests()">Save</button>
      </div>
    </div>
  </div>

</div>