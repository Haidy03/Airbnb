<div class="booking-wrapper">
  <!-- Booking Card -->
  <div class="booking-card">
    <!-- Header with Price and Rating -->
    <div class="booking-header">
      <div class="price-section">
        <div class="price-info">
          <span class="price">{{ currency }} {{ pricePerNight | number:'1.0-0' }}</span>
          <span class="per-night">night</span>
        </div>
        <!-- Note: Added 'star' class for better styling based on common practice -->
        <div class="rating-info" *ngIf="propertyRating && reviewsCount">
          <span class="star">★</span>
          <span class="rating-value">{{ propertyRating }}</span>
          <span class="dot">·</span>
          <!-- Note: Added 'reviews' class from original CSS suggestion -->
          <span class="reviews-link reviews">{{ reviewsCount }} reviews</span>
        </div>
      </div>
    </div>

    <!-- Booking Form -->
    <form [formGroup]="bookingForm" (ngSubmit)="onSubmit()" class="booking-form">

      <!-- Dates and Guests Combined Section (Form Container) -->
      <!-- This entire block now holds the border, mimicking the single input field look -->
      <div class="form-container main-section">
        <!-- Dates Row - Top part of the form container -->
        <div class="input-row dates-row">
          <!-- Check-in Date Field -->
          <div class="input-half date-field">
            <label class="input-label field-label">CHECK-IN</label>
            <input
              type="date"
              formControlName="checkIn"
              [min]="today"
              class="date-input"
              placeholder="Add date"
            />
          </div>

          <!-- Vertical Divider -->
          <div class="vertical-divider vertical-line"></div>

          <!-- Checkout Date Field -->
          <div class="input-half date-field">
            <label class="input-label field-label">CHECKOUT</label>
            <input
              type="date"
              formControlName="checkOut"
              [min]="bookingForm.get('checkIn')?.value || today"
              class="date-input"
              placeholder="Add date"
            />
          </div>
        </div>

        <!-- Horizontal Divider -->
        <div class="horizontal-divider horizontal-line"></div>

        <!-- Guests Row - Bottom part of the form container -->
        <div class="input-row guests-row" (click)="toggleGuestPicker()">
          <div class="guests-content guests-info">
            <label class="input-label field-label">GUESTS</label>
            <!-- Using .guests-display for the placeholder text style when no guests are selected (e.g., color: gray) -->
            <div class="guests-value guests-display">{{ getGuestsText() }}</div>
          </div>
          <!-- Dropdown Arrow Icon -->
          <svg
            class="dropdown-arrow arrow-icon"
            [class.rotated]="showGuestPicker"
            viewBox="0 0 32 32"
          >
            <!-- SVG path for the downward-pointing arrow -->
            <path d="m16 28 12-12-12-12-1.4 1.4L25.2 16 14.6 26.6z" transform="rotate(90 16 16)"/>
          </svg>
        </div>

        <!-- Guest Picker Dropdown -->
        <!-- Use .guest-dropdown for the absolute positioning and shadow -->
        <div class="guest-dropdown guest-picker" *ngIf="showGuestPicker">
          <!-- Adults -->
          <div class="guest-item guest-row">
            <div class="guest-details">
              <div class="guest-type">Adults</div>
              <div class="guest-age guest-desc">Age 13+</div>
            </div>
            <div class="guest-controls">
              <!-- Decrement Button -->
              <button
                type="button"
                class="control-btn stepper-btn"
                [disabled]="bookingForm.get('adults')?.value <= 1"
                (click)="decrementGuest('adults')"
              >
                <svg viewBox="0 0 32 32"><path d="M26 15H6v2h20z"/></svg>
              </button>
              <span class="guest-count guest-number">{{ bookingForm.get('adults')?.value }}</span>
              <!-- Increment Button -->
              <button
                type="button"
                class="control-btn stepper-btn"
                [disabled]="getTotalGuests() >= maxGuests"
                (click)="incrementGuest('adults')"
              >
                <svg viewBox="0 0 32 32"><path d="M26 15h-9V6h-2v9H6v2h9v9h2v-9h9z"/></svg>
              </button>
            </div>
          </div>

          <!-- Children -->
          <div class="guest-item guest-row">
            <div class="guest-details">
              <div class="guest-type">Children</div>
              <div class="guest-age guest-desc">Ages 2–12</div>
            </div>
            <div class="guest-controls">
              <!-- Decrement Button -->
              <button
                type="button"
                class="control-btn stepper-btn"
                [disabled]="bookingForm.get('children')?.value <= 0"
                (click)="decrementGuest('children')"
              >
                <svg viewBox="0 0 32 32"><path d="M26 15H6v2h20z"/></svg>
              </button>
              <span class="guest-count guest-number">{{ bookingForm.get('children')?.value }}</span>
              <!-- Increment Button -->
              <button
                type="button"
                class="control-btn stepper-btn"
                [disabled]="getTotalGuests() >= maxGuests"
                (click)="incrementGuest('children')"
              >
                <svg viewBox="0 0 32 32"><path d="M26 15h-9V6h-2v9H6v2h9v9h2v-9h9z"/></svg>
              </button>
            </div>
          </div>

          <!-- Infants -->
          <div class="guest-item guest-row">
            <div class="guest-details">
              <div class="guest-type">Infants</div>
              <div class="guest-age guest-desc">Under 2</div>
            </div>
            <div class="guest-controls">
              <!-- Decrement Button -->
              <button
                type="button"
                class="control-btn stepper-btn"
                [disabled]="bookingForm.get('infants')?.value <= 0"
                (click)="decrementGuest('infants')"
              >
                <svg viewBox="0 0 32 32"><path d="M26 15H6v2h20z"/></svg>
              </button>
              <span class="guest-count guest-number">{{ bookingForm.get('infants')?.value }}</span>
              <!-- Increment Button -->
              <button
                type="button"
                class="control-btn stepper-btn"
                (click)="incrementGuest('infants')"
              >
                <svg viewBox="0 0 32 32"><path d="M26 15h-9V6h-2v9H6v2h9v9h2v-9h9z"/></svg>
              </button>
            </div>
          </div>

          <!-- Pets -->
          <div class="guest-item guest-row">
            <div class="guest-details">
              <div class="guest-type">Pets</div>
              <div class="guest-age guest-desc">
                <a href="#" class="service-link link-text">Bringing a service animal?</a>
              </div>
            </div>
            <div class="guest-controls">
              <!-- Decrement Button -->
              <button
                type="button"
                class="control-btn stepper-btn"
                [disabled]="bookingForm.get('pets')?.value <= 0"
                (click)="decrementGuest('pets')"
              >
                <svg viewBox="0 0 32 32"><path d="M26 15H6v2h20z"/></svg>
              </button>
              <span class="guest-count guest-number">{{ bookingForm.get('pets')?.value }}</span>
              <!-- Increment Button -->
              <button
                type="button"
                class="control-btn stepper-btn"
                (click)="incrementGuest('pets')"
              >
                <svg viewBox="0 0 32 32"><path d="M26 15h-9V6h-2v9H6v2h9v9h2v-9h9z"/></svg>
              </button>
            </div>
          </div>

          <!-- Max guests warning -->
          <div class="max-guests-note max-warning" *ngIf="getTotalGuests() >= maxGuests">
            This place has a maximum of {{ maxGuests }} guests, not including infants.
          </div>

          <!-- Close button -->
          <div class="dropdown-footer">
            <button type="button" class="close-dropdown close-picker" (click)="closeGuestPicker()">
              Close
            </button>
          </div>
        </div>
      </div>
      <!-- End of Dates and Guests Combined Section -->

      <!-- Error Message -->
      <div class="error-alert error-box" *ngIf="errorMessage">
        <svg viewBox="0 0 16 16" fill="currentColor">
          <path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0zm0 10.2a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm.8-6.6H7.2v5.2h1.6V3.6z"/>
        </svg>
        <span>{{ errorMessage }}</span>
      </div>

      <!-- Reserve Button -->
      <button
        type="submit"
        class="reserve-button reserve-btn"
        [disabled]="isLoading"
        [class.loading]="isLoading"
      >
        <span *ngIf="!isLoading">Reserve</span>
        <div *ngIf="isLoading" class="spinner btn-spinner"></div>
      </button>

      <!-- Notice Text -->
      <p class="charge-notice notice-text">You won't be charged yet</p>

      <!-- Price Breakdown -->
      <div class="price-breakdown price-details" *ngIf="priceBreakdown">
        <!-- Base Price per Night -->
        <div class="price-item price-line">
          <!-- Used .price-label.underlined for the dotted underline text -->
          <span class="price-label underlined price-desc underline">
            {{ currency }} {{ priceBreakdown.pricePerNight | number:'1.0-0' }} x {{ priceBreakdown.numberOfNights }} night{{ priceBreakdown.numberOfNights > 1 ? 's' : '' }}
          </span>
          <span class="price-value price-amount">{{ currency }} {{ priceBreakdown.basePrice | number:'1.2-2' }}</span>
        </div>

        <!-- Cleaning Fee -->
        <div class="price-item price-line" *ngIf="priceBreakdown.cleaningFee > 0">
          <span class="price-label underlined price-desc underline">Cleaning fee</span>
          <span class="price-value price-amount">{{ currency }} {{ priceBreakdown.cleaningFee | number:'1.2-2' }}</span>
        </div>

        <!-- Service Fee -->
        <div class="price-item price-line" *ngIf="priceBreakdown.serviceFee > 0">
          <span class="price-label underlined price-desc underline">Service fee</span>
          <span class="price-value price-amount">{{ currency }} {{ priceBreakdown.serviceFee | number:'1.2-2' }}</span>
        </div>

        <!-- Discount Line -->
        <div class="price-item price-line discount-line" *ngIf="priceBreakdown.discount">
          <!-- Used .discount-label for the green label color -->
          <span class="price-label discount-label price-desc">Long stay discount</span>
          <!-- Used .discount-value for the green value color -->
          <span class="price-value discount-value price-amount discount">-{{ currency }} {{ priceBreakdown.discount | number:'1.2-2' }}</span>
        </div>

        <!-- Taxes -->
        <div class="price-item price-line" *ngIf="priceBreakdown.tax > 0">
          <span class="price-label underlined price-desc underline">Taxes</span>
          <span class="price-value price-amount">{{ currency }} {{ priceBreakdown.tax | number:'1.2-2' }}</span>
        </div>

        <!-- Divider -->
        <div class="price-divider divider-line"></div>

        <!-- Total Price -->
        <div class="price-item total-price price-line total-line">
          <span class="price-label price-desc">Total {{ priceBreakdown.currency }}</span>
          <span class="price-value price-amount">{{ currency }} {{ priceBreakdown.totalPrice | number:'1.2-2' }}</span>
        </div>
      </div>
    </form>

    <!-- Report Link -->
    <div class="report-section">
      <a href="#" class="report-link">
        <svg viewBox="0 0 16 16" fill="currentColor">
          <path d="M9 1a1 1 0 0 1 1 .88V3h3.5a1 1 0 0 1 1 .88v9.25a1 1 0 0 1-.88 1H2.5a1 1 0 0 1-1-.88V3.87a1 1 0 0 1 .88-1H6V2a1 1 0 0 1 .88-1H9z"/>
        </svg>
        Report this listing
      </a>
    </div>
  </div>
</div>

<!-- Backdrop -->
<div
  class="picker-backdrop backdrop"
  *ngIf="showGuestPicker"
  (click)="closeGuestPicker()"
></div>
