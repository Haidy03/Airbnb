<div class="booking-card">
  <!-- Header with Price -->
  <div class="booking-header">
    <div class="price-section">
      <div class="price-info">
        <span class="price">{{ currency === 'USD' ? '$' : 'EGP ' }}{{ pricePerNight }}</span>
        <span class="per-night">night</span>
      </div>
      <div class="rating-info" *ngIf="propertyRating">
        <span class="rating">★ {{ propertyRating }}</span>
        <span class="reviews">({{ reviewsCount }} reviews)</span>
      </div>
    </div>
  </div>

  <!-- Form -->
  <form [formGroup]="bookingForm" (ngSubmit)="onSubmit()" class="booking-form">

    <!-- Dates and Guests Combined Section -->
    <div class="form-section main-section">
      <!-- Dates Row -->
      <div class="input-row dates-row">
        <div class="input-half">
          <label class="input-label">CHECK-IN</label>
          <input
            type="text"
            formControlName="checkIn"
            class="date-input"
            placeholder="Add date"
            [min]="today"
            onfocus="(this.type='date')"
            onblur="if(!this.value)this.type='text'"
          />
        </div>

        <div class="vertical-divider"></div>

        <div class="input-half">
          <label class="input-label">CHECKOUT</label>
          <input
            type="text"
            formControlName="checkOut"
            class="date-input"
            placeholder="Add date"
            [min]="bookingForm.get('checkIn')?.value || today"
            onfocus="(this.type='date')"
            onblur="if(!this.value)this.type='text'"
          />
        </div>
      </div>

      <div class="horizontal-divider"></div>

      <!-- Guests Row -->
      <div class="input-row guests-row" (click)="toggleGuestPicker()">
        <div class="guests-content">
          <label class="input-label">GUESTS</label>
          <div class="guests-display">{{ getGuestsText() }}</div>
        </div>
        <svg
          class="dropdown-arrow"
          [class.rotated]="showGuestPicker"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="M6 9l6 6 6-6"/>
        </svg>
      </div>

      <!-- Guest Picker Dropdown -->
      <div class="guest-dropdown" *ngIf="showGuestPicker" [@slideDown]>
        <!-- Adults -->
        <div class="guest-item">
          <div class="guest-details">
            <div class="guest-type">Adults</div>
            <div class="guest-age">Age 13+</div>
          </div>
          <div class="guest-controls">
            <button
              type="button"
              class="control-btn"
              [class.disabled]="bookingForm.get('adults')?.value <= 1"
              (click)="decrementGuest('adults')"
            >
              <svg viewBox="0 0 32 32" fill="currentColor">
                <path d="M26 15H6v2h20z"/>
              </svg>
            </button>
            <span class="guest-count">{{ bookingForm.get('adults')?.value }}</span>
            <button
              type="button"
              class="control-btn"
              [class.disabled]="getTotalGuests() >= maxGuests"
              (click)="incrementGuest('adults')"
            >
              <svg viewBox="0 0 32 32" fill="currentColor">
                <path d="M26 15h-9V6h-2v9H6v2h9v9h2v-9h9z"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Children -->
        <div class="guest-item">
          <div class="guest-details">
            <div class="guest-type">Children</div>
            <div class="guest-age">Ages 2–12</div>
          </div>
          <div class="guest-controls">
            <button
              type="button"
              class="control-btn"
              [class.disabled]="bookingForm.get('children')?.value <= 0"
              (click)="decrementGuest('children')"
            >
              <svg viewBox="0 0 32 32" fill="currentColor">
                <path d="M26 15H6v2h20z"/>
              </svg>
            </button>
            <span class="guest-count">{{ bookingForm.get('children')?.value }}</span>
            <button
              type="button"
              class="control-btn"
              [class.disabled]="getTotalGuests() >= maxGuests"
              (click)="incrementGuest('children')"
            >
              <svg viewBox="0 0 32 32" fill="currentColor">
                <path d="M26 15h-9V6h-2v9H6v2h9v9h2v-9h9z"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Infants -->
        <div class="guest-item">
          <div class="guest-details">
            <div class="guest-type">Infants</div>
            <div class="guest-age">Under 2</div>
          </div>
          <div class="guest-controls">
            <button
              type="button"
              class="control-btn"
              [class.disabled]="bookingForm.get('infants')?.value <= 0"
              (click)="decrementGuest('infants')"
            >
              <svg viewBox="0 0 32 32" fill="currentColor">
                <path d="M26 15H6v2h20z"/>
              </svg>
            </button>
            <span class="guest-count">{{ bookingForm.get('infants')?.value }}</span>
            <button
              type="button"
              class="control-btn"
              (click)="incrementGuest('infants')"
            >
              <svg viewBox="0 0 32 32" fill="currentColor">
                <path d="M26 15h-9V6h-2v9H6v2h9v9h2v-9h9z"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Pets -->
        <div class="guest-item">
          <div class="guest-details">
            <div class="guest-type">Pets</div>
            <div class="guest-age">
              <a href="#" class="service-link">Bringing a service animal?</a>
            </div>
          </div>
          <div class="guest-controls">
            <button
              type="button"
              class="control-btn"
              [class.disabled]="bookingForm.get('pets')?.value <= 0"
              (click)="decrementGuest('pets')"
            >
              <svg viewBox="0 0 32 32" fill="currentColor">
                <path d="M26 15H6v2h20z"/>
              </svg>
            </button>
            <span class="guest-count">{{ bookingForm.get('pets')?.value }}</span>
            <button
              type="button"
              class="control-btn"
              (click)="incrementGuest('pets')"
            >
              <svg viewBox="0 0 32 32" fill="currentColor">
                <path d="M26 15h-9V6h-2v9H6v2h9v9h2v-9h9z"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Max guests message -->
        <div class="max-guests-note" *ngIf="getTotalGuests() >= maxGuests">
          This place has a maximum of {{ maxGuests }} guests, not including infants.
        </div>

        <!-- Close Button -->
        <div class="dropdown-footer">
          <button type="button" class="close-dropdown" (click)="closeGuestPicker()">
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Error Message -->
    <div class="error-alert" *ngIf="errorMessage">
      <svg viewBox="0 0 16 16" fill="currentColor">
        <path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0zm0 10.2a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm.8-6.6H7.2v5.2h1.6V3.6z"/>
      </svg>
      <span>{{ errorMessage }}</span>
    </div>

    <!-- Reserve Button -->
    <button
      type="submit"
      class="reserve-button"
      [disabled]="isLoading || !bookingForm.valid"
      [class.loading]="isLoading"
    >
      <span *ngIf="!isLoading">Reserve</span>
      <div *ngIf="isLoading" class="spinner"></div>
    </button>

    <!-- Notice -->
    <p class="charge-notice">You won't be charged yet</p>

    <!-- Price Breakdown -->
    <div class="price-breakdown" *ngIf="priceBreakdown">
      <div class="price-item">
        <span class="price-label">
          {{ currency === 'USD' ? '$' : 'EGP ' }}{{ priceBreakdown.pricePerNight }} x {{ priceBreakdown.numberOfNights }} night{{ priceBreakdown.numberOfNights !== 1 ? 's' : '' }}
        </span>
        <span class="price-value">{{ currency === 'USD' ? '$' : 'EGP ' }}{{ priceBreakdown.basePrice.toFixed(2) }}</span>
      </div>

      <div class="price-item">
        <span class="price-label underlined">Cleaning fee</span>
        <span class="price-value">{{ currency === 'USD' ? '$' : 'EGP ' }}{{ priceBreakdown.cleaningFee.toFixed(2) }}</span>
      </div>

      <div class="price-item">
        <span class="price-label underlined">Service fee</span>
        <span class="price-value">{{ currency === 'USD' ? '$' : 'EGP ' }}{{ priceBreakdown.serviceFee.toFixed(2) }}</span>
      </div>

      <div class="price-item" *ngIf="priceBreakdown.discount">
        <span class="price-label discount-label">Long stay discount</span>
        <span class="price-value discount-value">-{{ currency === 'USD' ? '$' : 'EGP ' }}{{ priceBreakdown.discount.toFixed(2) }}</span>
      </div>

      <div class="price-item">
        <span class="price-label underlined">Taxes</span>
        <span class="price-value">{{ currency === 'USD' ? '$' : 'EGP ' }}{{ priceBreakdown.tax.toFixed(2) }}</span>
      </div>

      <div class="price-divider"></div>

      <div class="price-item total-price">
        <span class="price-label">Total ({{ priceBreakdown.currency }})</span>
        <span class="price-value">{{ currency === 'USD' ? '$' : 'EGP ' }}{{ priceBreakdown.totalPrice.toFixed(2) }}</span>
      </div>
    </div>
  </form>

  <!-- Report listing link -->
  <div class="report-section">
    <a href="#" class="report-link">
      <svg viewBox="0 0 16 16" fill="currentColor">
        <path d="M8.5 1A1.5 1.5 0 0 0 7 2.5V6H3.5a1.5 1.5 0 0 0 0 3H7v3.5A1.5 1.5 0 0 0 8.5 14h0a1.5 1.5 0 0 0 1.5-1.5V9h3.5a1.5 1.5 0 0 0 0-3H10V2.5A1.5 1.5 0 0 0 8.5 1z"/>
      </svg>
      Report this listing
    </a>
  </div>
</div>

<!-- Backdrop for guest picker -->
<div
  class="picker-backdrop"
  *ngIf="showGuestPicker"
  (click)="closeGuestPicker()"
></div>
