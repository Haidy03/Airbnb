<app-header></app-header>
<div *ngIf="isLoading()" class="loading-container">
  <div class="spinner"></div>
  <p>Loading...</p>
</div>

<div *ngIf="error()" class="error-container">
  <p>{{ error() }}</p>
  <button (click)="loadExperience(experience()?.id || 0)" class="retry-btn">Retry</button>
</div>

<div *ngIf="!isLoading() && !error() && experience()" class="booking-container">
  
  <!-- Header -->
  <div class="booking-header">
    <button class="back-btn" (click)="goBack()">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
    </button>
    <h1 class="page-title">Book Experience</h1>
  </div>

  <!-- Content Grid -->
  <div class="booking-content">
    
    <!-- Left: Experience Summary -->
    <div class="experience-summary">
      <img 
        [src]="experience()!.images[0]?.imageUrl || 'https://via.placeholder.com/400x300'" 
        [alt]="experience()!.title"
        class="summary-image">
      
      <div class="summary-info">
        <h2>{{ experience()!.title }}</h2>
        <p class="summary-host">
             Hosted by {{ experience()!.hostName }}
        </p>
        
        <div class="summary-details">
          <div class="detail-item">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
              <circle cx="10" cy="10" r="8"/>
              <path d="M10 5v5l3 3"/>
            </svg>
            <span>{{ experience()!.formattedDuration }}</span>
          </div>
          
          <div class="detail-item">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
              <path d="M10 2a4 4 0 100 8 4 4 0 000-8zM2 10a4 4 0 118 0 4 4 0 01-8 0z"/>
            </svg>
            <span>Up to {{ experience()!.maxGroupSize }} guests</span>
          </div>
          
          <div class="detail-item" *ngIf="experience()!.averageRating > 0">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
              <path d="M10 0l2.575 6.9L20 7.725l-5.75 4.825L15.65 20 10 16.063 4.35 20l1.4-7.45L0 7.725l7.425-.825z"/>
            </svg>
            <span>{{ experience()!.averageRating.toFixed(1) }} ({{ experience()!.totalReviews }})</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Right: Booking Form -->
    <div class="booking-form-container">
      <form class="booking-form" (ngSubmit)="onSubmit()">
        
        <h3 class="form-title">Select date and time</h3>

        <!-- âœ… ØªØµÙ…ÙŠÙ… Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
        <div class="datetime-container">
          
          <!-- Ù‚Ø³Ù… Ø§Ù„ØªØ§Ø±ÙŠØ® -->
          <div class="date-section">
            <label>Date</label>
            <select 
              [(ngModel)]="selectedDate" 
              name="date" 
              class="custom-select" 
              (change)="onDateSelected()" 
              required>
              <option value="" disabled selected>Choose date</option>
              <option *ngFor="let date of availableDates" [value]="date.toISOString()">
                {{ formatDate(date) }}
              </option>
            </select>
          </div>

          <!-- Ù‚Ø³Ù… Ø§Ù„ÙˆÙ‚Øª (Ø¸Ø§Ù‡Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹) -->
          <div class="time-section">
            <h4>Time</h4>
            
            <div *ngIf="!selectedDate" class="no-slots-msg">
              Select a date above to see available times
            </div>

            <div *ngIf="selectedDate && availableTimes.length === 0" class="no-slots-msg">
              No available slots for this date
            </div>

            <div class="time-grid" *ngIf="availableTimes.length > 0">
              <button 
                type="button"
                *ngFor="let slot of availableTimes" 
                class="time-pill"
                [class.selected]="selectedTime === slot.time"
                (click)="selectTime(slot.time)">
                {{ slot.time }}
                <span style="font-size: 10px; display: block; color: inherit; opacity: 0.8;">
                   ({{ slot.spots }} spots)
                </span>
              </button>
            </div>
          </div>
        </div>

        <!-- Number of Guests -->
        <div class="form-group">
          <label class="form-label">
            Number of guests 
            ({{ experience()!.minGroupSize }}-{{ experience()!.maxGroupSize }})
          </label>
          
          <div class="guest-selector">
            <button 
              type="button"
              class="guest-btn"
              [disabled]="numberOfGuests <= experience()!.minGroupSize"
              (click)="numberOfGuests = numberOfGuests - 1">
              <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="presentation" focusable="false" style="display: block; fill: none; height: 12px; width: 12px; stroke: currentcolor; stroke-width: 5.33333; overflow: visible;">
                <path d="M2 16h28"></path>
              </svg>
            </button>

            <span class="guest-count">{{ numberOfGuests }}</span>

            <button 
              type="button"
              class="guest-btn"
              [disabled]="numberOfGuests >= experience()!.maxGroupSize"
              (click)="numberOfGuests = numberOfGuests + 1">
              <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="presentation" focusable="false" style="display: block; fill: none; height: 12px; width: 12px; stroke: currentcolor; stroke-width: 5.33333; overflow: visible;">
                <path d="M2 16h28M16 2v28"></path>
              </svg>
            </button>
          </div>
        </div>

        <!-- Special Requests -->
        <div class="form-group">
          <label class="form-label">Special requests (optional)</label>
          <textarea
            [(ngModel)]="specialRequests"
            name="requests"
            class="form-textarea"
            rows="3"
            placeholder="Any special requirements or dietary restrictions?"></textarea>
        </div>

        <!-- Payment Section -->
         <div class="payment-section">
          <h3 class="form-title" style="margin-top: 24px;">Pay with</h3>
          
          <div class="card-icons">
            <span class="card-icon">ðŸ’³</span>
            <span class="card-icon">VISA</span>
            <span class="card-icon">MC</span>
          </div>

          <div class="form-group">
            <label class="form-label">Card Number</label>
            <input 
              type="text" 
              class="form-input" 
              placeholder="0000 0000 0000 0000"
              [(ngModel)]="paymentDetails.cardNumber"
              name="cardNumber"
              maxlength="19"
              (input)="formatCardNumber($event)"
              required>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Expiration</label>
              <input 
                type="text" 
                class="form-input" 
                placeholder="MM/YY"
                [(ngModel)]="paymentDetails.expiration"
                name="expiration"
                maxlength="5"
                required>
            </div>
            
            <div class="form-group">
              <label class="form-label">CVV</label>
              <input 
                type="text" 
                class="form-input"
                [(ngModel)]="paymentDetails.cvv"
                name="cvv"
                maxlength="3"
                required>
            </div>
          </div>
        </div>

        <!-- Price Summary -->
        <div class="price-summary">
          <div class="price-row">
            <span>EGP{{ experience()!.pricePerPerson }} Ã— {{ numberOfGuests }} guest{{ numberOfGuests > 1 ? 's' : '' }}</span>
            <span>EGP{{ calculateTotalPrice() }}</span>
          </div>
          <div class="price-total">
            <span>Total</span>
            <span>EGP{{ calculateTotalPrice() }}</span>
          </div>
        </div>

        <!-- Submit Button -->
        <button 
          type="submit" 
          class="book-btn" 
          [disabled]="isBooking() || !selectedDate || !selectedTime || !isPaymentValid()">
          <span *ngIf="!isBooking()">Confirm and pay</span>
          <span *ngIf="isBooking()">Processing payment...</span>
        </button>

        <p class="booking-note">You'll be charged immediately upon confirmation</p>

        <!-- Cancellation Policy -->
        <div class="cancellation-policy">
          <h4>Cancellation policy</h4>
          <p>{{ experience()!.cancellationPolicy }}</p>
        </div>
      </form>
    </div>
  </div>
</div>