<div class="create-experience-container">
  
  <!-- Step Navigation Header -->
  <div class="stepper-header">
    <div class="stepper-content">
      <div class="step-indicator">
        Step {{ currentStep() }} of {{ totalSteps }}
      </div>
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="(currentStep() / totalSteps) * 100"></div>
      </div>
      <h2 class="step-title">
        <ng-container [ngSwitch]="currentStep()">
          <span *ngSwitchCase="1">Set your Schedule</span>
          <span *ngSwitchCase="2">Basic Information</span>
          <span *ngSwitchCase="3">Location & Duration</span>
          <span *ngSwitchCase="4">Details & Pricing</span>
          <span *ngSwitchCase="5">Upload Photos</span>
        </ng-container>
      </h2>
    </div>
    <button class="close-btn" (click)="cancel()">√ó</button>
  </div>

  <div class="form-container">
    <form [formGroup]="experienceForm" (ngSubmit)="onSubmit()">

      <!-- STEP 1: Schedule -->
      <div class="form-section" *ngIf="currentStep() === 1">
        <p class="section-subtitle">Choose at least one date and time for your experience.</p>
        
        <div class="availability-form-row">
          <div class="form-group" style="flex: 1;">
            <label class="form-label">Date</label>
            <input 
            type="date" 
            [(ngModel)]="newSlotDate" 
            [ngModelOptions]="{standalone: true}" 
            [min]="minDate"
            class="form-input">
          </div>
          <div class="form-group" style="flex: 1;">
            <label class="form-label">Start Time</label>
            <input type="time" [(ngModel)]="newSlotTime" [ngModelOptions]="{standalone: true}" class="form-input">
          </div>
          <button 
            type="button" 
            class="add-slot-btn" 
            (click)="addSlot()"
            [disabled]="tempSlots().length >= 6">
            + Add
          </button>
        </div>

        <div *ngIf="tempSlots().length > 0" class="slots-list mb-4">
          <h4 class="mini-title">New slots to be added:</h4>
          <div *ngFor="let slot of tempSlots(); let i = index" class="slot-card new-slot">
            <div class="slot-info">
              <span class="slot-date">{{ slot.date | date:'mediumDate' }}</span>
              <span class="slot-time">{{ formatTime(slot.startTime) }} - {{ formatTime(slot.endTime) }}</span>
            </div>
            <button type="button" class="remove-slot-btn" (click)="removeSlot(i)">√ó</button>
          </div>
        </div>

        <div *ngIf="existingSlots().length > 0" class="slots-list">
          <h4 class="mini-title">Existing Schedule:</h4>
          <div *ngFor="let slot of existingSlots()" class="slot-card existing-slot">
            <div class="slot-info">
              <span class="slot-date">{{ slot.date | date:'mediumDate' }}</span>
              <span class="slot-time">{{ formatTime(slot.startTime) }} - {{ formatTime(slot.endTime) }}</span>
              <span class="slot-spots">{{ slot.availableSpots }} spots left</span>
            </div>
            <button type="button" class="remove-slot-btn" (click)="deleteExistingSlot(slot.id)">üóëÔ∏è</button>
          </div>
        </div>
      </div>

      <!-- STEP 2: Basic Info -->
      <div class="form-section" *ngIf="currentStep() === 2">
        <div class="form-group">
          <label class="form-label">Experience Title *</label>
          <input type="text" formControlName="title" class="form-input" placeholder="e.g., Traditional Egyptian Cooking Class">
          <div *ngIf="experienceForm.get('title')?.invalid && experienceForm.get('title')?.touched" class="error-message">
            Title is required (max 200 chars).
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Description *</label>
          <textarea formControlName="description" class="form-textarea" rows="6" placeholder="Describe your experience..."></textarea>
          <div *ngIf="experienceForm.get('description')?.invalid && experienceForm.get('description')?.touched" class="error-message">
            Description is required.
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Category *</label>
            <select formControlName="categoryId" class="form-select">
              <option [value]="null">Select a category</option>
              <option *ngFor="let category of categories()" [value]="category.id">
                {{ category.icon }} {{ category.name }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Type *</label>
            <div class="type-buttons">
              <button *ngFor="let type of experienceTypes" type="button" class="type-btn"
                [class.active]="experienceForm.get('type')?.value === type.value"
                (click)="experienceForm.patchValue({ type: type.value })">
                <span class="type-icon">{{ type.icon }}</span>
                <span>{{ type.label }}</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- STEP 3: Location & Duration -->
      <div class="form-section" *ngIf="currentStep() === 3">
        <ng-container *ngIf="experienceForm.get('type')?.value !== 'Online'">
          <div class="form-group">
            <label class="form-label">Address</label>
            <input type="text" formControlName="address" class="form-input" placeholder="Street address">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">City *</label>
              <input type="text" formControlName="city" class="form-input" placeholder="Cairo">
            </div>
            <div class="form-group">
              <label class="form-label">Country *</label>
              <input type="text" formControlName="country" class="form-input" placeholder="Egypt">
            </div>
          </div>
        </ng-container>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Duration *</label>
            <div class="duration-inputs">
              <input type="number" formControlName="durationHours" class="form-input" min="0" placeholder="Hours">
              <span class="duration-separator">:</span>
              <input type="number" formControlName="durationMinutes" class="form-input" min="0" max="59" placeholder="Mins">
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Group Size *</label>
            <div class="group-size-inputs">
              <input type="number" formControlName="minGroupSize" class="form-input" min="1" placeholder="Min">
              <span class="group-separator">to</span>
              <input type="number" formControlName="maxGroupSize" class="form-input" min="1" placeholder="Max">
            </div>
          </div>
        </div>
      </div>

      <!-- STEP 4: Details & Pricing -->
      <div class="form-section" *ngIf="currentStep() === 4">
        <div class="form-group">
          <label class="form-label">Price per Person (EGP) *</label>
          <div class="price-input-wrapper">
            <span class="currency-symbol"></span>
            <input type="number" formControlName="pricePerPerson" class="form-input price-input" min="1" placeholder="50">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Age Requirement</label>
            <input type="text" formControlName="ageRequirement" class="form-input" placeholder="e.g., 18+">
          </div>
          <div class="form-group">
            <label class="form-label">Skill Level</label>
            <select formControlName="skillLevel" class="form-select">
              <option>Beginner</option>
              <option>Intermediate</option>
              <option>Advanced</option>
              <option>All levels</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">What to Bring</label>
          <textarea formControlName="whatToBring" class="form-textarea" rows="2" placeholder="List items..."></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">What's Included</label>
          <textarea formControlName="whatIsIncluded" class="form-textarea" rows="2" placeholder="What's provided..."></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Cancellation Policy</label>
          <textarea formControlName="cancellationPolicy" class="form-textarea" rows="2"></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Languages Offered</label>
          <div class="language-chips">
            <button *ngFor="let lang of languages" type="button" class="language-chip"
              [class.active]="selectedLanguages.includes(lang.code)"
              (click)="toggleLanguage(lang.code)">
              {{ lang.name }}
            </button>
          </div>
        </div>
      </div>

      <!-- STEP 5: Photos -->
      <div class="form-section" *ngIf="currentStep() === 5">
        <p class="section-subtitle">Showcase your experience with high-quality photos.</p>

        <div class="photos-grid">
          <!-- 1. Pending Photos (Create Mode) -->
          <div *ngFor="let preview of pendingPhotoPreviews(); let i = index" class="photo-card">
            <img [src]="preview" alt="New Photo">
            <div class="photo-actions">
              <button type="button" class="photo-btn delete" (click)="removePendingPhoto(i)">√ó</button>
            </div>
          </div>

          <!-- 2. Existing Photos (Edit Mode) -->
          <ng-container *ngIf="isEditMode && existingExperience()">
            <div *ngFor="let img of existingExperience()!.images" class="photo-card">
              <img [src]="getImageUrl(img.imageUrl)" alt="Experience Image">
              <div class="photo-actions">
                <button type="button" class="photo-btn delete" (click)="deleteImage(img.id)">√ó</button>
                <button type="button" *ngIf="!img.isPrimary" class="photo-btn primary" (click)="setPrimaryImage(img.id)">‚òÖ</button>
                <span *ngIf="img.isPrimary" class="primary-badge">Main</span>
              </div>
            </div>
          </ng-container>

          <!-- Upload Button -->
          <label class="upload-box" [class.disabled]="isUploading()">
            <input type="file" (change)="onFileSelected($event)" accept="image/*" [disabled]="isUploading()" hidden>
            <div *ngIf="!isUploading()">
              <span class="plus-icon">+</span>
              <span>Upload</span>
            </div>
            <div *ngIf="isUploading()" class="spinner-small"></div>
          </label>
        </div>
      </div>

      <!-- Error Message -->
      <div *ngIf="error()" class="error-alert">
        {{ error() }}
      </div>

      <!-- Footer Actions -->
      <div class="form-actions-footer">
        <button type="button" class="action-btn back-btn" (click)="prevStep()" [disabled]="currentStep() === 1 || isSubmitting()">
          Back
        </button>

        <button *ngIf="currentStep() < totalSteps" type="button" class="action-btn next-btn" (click)="nextStep()">
          Next
        </button>

        <button *ngIf="currentStep() === totalSteps" type="submit" class="action-btn submit-btn" [disabled]="isSubmitting()">
          <span *ngIf="!isSubmitting()">Submit & Save</span>
          <span *ngIf="isSubmitting()">Saving...</span>
        </button>
      </div>

    </form>
  </div>
</div>