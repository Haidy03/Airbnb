<div class="chat-container">
  
  <!-- Chat Header -->
  <div class="chat-header">
    <button class="back-button" (click)="goBack()">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
    </button>

    <div class="header-user-info" *ngIf="conversation()">
      <img 
        [src]="getOtherParticipant()?.avatar || '/assets/default-avatar.png'" 
        [alt]="getOtherParticipant()?.name"
        class="header-avatar">
      <div class="header-details">
        <h2 class="header-name">{{ getOtherParticipant()?.name }}</h2>
        <p class="header-property" *ngIf="conversation()?.propertyTitle">
          {{ conversation()?.propertyTitle }}
        </p>
      </div>
    </div>

    <div class="header-actions">
      <span 
        class="online-status" 
        [class.online]="getOtherParticipant()?.isOnline">
        {{ getOtherParticipant()?.isOnline ? 'Online' : 'Offline' }}
      </span>
    </div>
  </div>

  <!-- Messages Container -->
  <div class="messages-wrapper" #messagesContainer>
    
    <!-- Loading State -->
    <div *ngIf="isLoading()" class="loading-state">
      <div class="spinner"></div>
      <p>Loading messages...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="error()" class="error-state">
      <p>{{ error() }}</p>
      <button (click)="loadMessages()">Retry</button>
    </div>

    <!-- Messages List -->
    <div *ngIf="!isLoading() && !error()" class="messages-list">
      
      <ng-container *ngFor="let message of messages(); let i = index">
        
        <!-- Date Separator -->
        <div *ngIf="shouldShowDateSeparator(message, i)" class="date-separator">
          <span>{{ formatMessageDate(message.sentAt) }}</span>
        </div>

        <!-- Message Bubble -->
        <div 
          class="message-row"
          [class.my-message]="isMyMessage(message)"
          [class.their-message]="!isMyMessage(message)">
          
          <div class="message-bubble">
            <p class="message-content">{{ message.content }}</p>
            
            <div class="message-footer">
              <span class="message-time">{{ formatMessageTime(message.sentAt) }}</span>
              
              <span *ngIf="isMyMessage(message)" class="message-status">
                <svg *ngIf="message.isRead" width="16" height="16" viewBox="0 0 16 16" fill="#00A699">
                  <path d="M13.5 2L6 9.5L2.5 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <path d="M13.5 2L6 9.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <svg *ngIf="!message.isRead && message.isDelivered" width="16" height="16" viewBox="0 0 16 16" fill="#717171">
                  <path d="M13.5 2L6 9.5L2.5 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </span>

              <button 
                *ngIf="isMyMessage(message)" 
                class="delete-btn"
                (click)="deleteMessage(message.id)"
                title="Delete message">
                <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor">
                  <path d="M1 3h12M5 1h4M5 6v5M9 6v5M2 3l1 10h8l1-10"/>
                </svg>
              </button>
            </div>
          </div>

        </div>

      </ng-container>

    </div>
  </div>

  <!-- Message Input -->
  <div class="message-input-container">
    <div class="input-wrapper">
      <textarea
        [(ngModel)]="messageText"
        (keypress)="onKeyPress($event)"
        placeholder="Type a message..."
        class="message-input"
        rows="1"
        [disabled]="isSending()"></textarea>

      <button 
        class="send-button"
        (click)="sendMessage()"
        [disabled]="!messageText.trim() || isSending()">
        <svg *ngIf="!isSending()" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M2 21l21-9L2 3v7l15 2-15 2z"/>
        </svg>
        <div *ngIf="isSending()" class="mini-spinner"></div>
      </button>
    </div>
  </div>

</div>